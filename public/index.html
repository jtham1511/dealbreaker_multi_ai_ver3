<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gartner Contract Evaluation Platform</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --secondary: #64748b;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header p {
            color: var(--text-muted);
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            background: var(--surface);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 150px;
        }

        .tab:hover {
            background: rgba(30, 64, 175, 0.1);
            color: var(--primary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--surface);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h3 {
            margin-bottom: 15px;
            color: var(--text);
            font-size: 1.2rem;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        .metric-card {
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-placeholder {
            height: 250px;
            background: var(--background);
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #047857;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--background);
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: var(--primary);
        }

        .alert-success {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.2);
            color: var(--success);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(217, 119, 6, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        .chat-interface {
            border: 1px solid var(--border);
            border-radius: 8px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--background);
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            gap: 10px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 80%;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .message-user {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }

        .message br {
            display: block;
            margin: 0.5rem 0;
            content: "";
        }

        .message-bot {
            background: var(--surface);
            border: 1px solid var(--border);
        }

        .insight-card {
            border-left: 4px solid var(--primary);
            background: var(--surface);
            padding: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-chart-line"></i> Gartner Contract Evaluation Platform</h1>
            <p>Intelligent analytics for procurement decision-making</p>
        </div>
		<div class="container" style="text-align: right;">
			<p>All Right Reserved CET dealBreaker Team 2025</p>
		</div>
    </header>

    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">
                <i class="fas fa-tachometer-alt"></i> Overview Dashboard
            </button>
            <button class="tab" onclick="showTab('insights')">
                <i class="fas fa-lightbulb"></i> Insights Engine
            </button>
<!--            <button class="tab" onclick="showTab('ai-discovery')">
                <i class="fas fa-robot"></i> AI Discovery Bot
            </button>   -->
            <button class="tab" onclick="showTab('optimizer')">
                <i class="fas fa-cogs"></i> Decision Optimizer
            </button>
            <button class="tab" onclick="showTab('reports')">
                <i class="fas fa-file-alt"></i> Report Generator
            </button>
        </div>

        <!-- Tab 1: Overview Dashboard -->
        <div id="overview" class="tab-content active">
            <!-- Key Metrics (Updated) -->
            <div class="grid grid-4">
                <div class="metric-card">
                    <div class="metric-value">38</div>
                    <div class="metric-label">Licensed Users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">68%</div>
                    <div class="metric-label">Active Utilization Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$632</div>
                    <div class="metric-label">Cost per Download</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">4.1</div>
                    <div class="metric-label">User Satisfaction (5.0 scale)</div>
                </div>
            </div>

            <!-- Contract Timeline and Data Coverage -->
            <div class="card">
                <h3>üìÖ Contract Timeline & Data Coverage</h3>
                <div class="alert alert-info" style="margin-bottom: 20px;">
                    <strong>Contract Period:</strong> July 2023 - July 2026 (36 months) | 
                    <strong>Data Available:</strong> Aug 2023 - Mar 2025 (20 months) | 
                    <strong>Remaining:</strong> Apr 2025 - Jul 2026 (16 months)
                </div>
                <div class="grid grid-3">
                    <div style="text-align: center; padding: 15px; background: rgba(5, 150, 105, 0.05); border-radius: 8px;">
                        <h4 style="color: #059669; margin-bottom: 10px;">20/36</h4>
                        <p><strong>Months with Data</strong></p>
                        <p style="font-size: 0.9rem; color: #64748b;">56% of contract period</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 8px;">
                        <h4 style="color: #1e40af; margin-bottom: 10px;">16</h4>
                        <p><strong>Months Remaining</strong></p>
                        <p style="font-size: 0.9rem; color: #64748b;">44% of contract left</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(217, 119, 6, 0.05); border-radius: 8px;">
                        <h4 style="color: #d97706; margin-bottom: 10px;">$3.12M</h4>
                        <p><strong>Projected Final Spend</strong></p>
                        <p style="font-size: 0.9rem; color: #64748b;">Based on current trend</p>
                    </div>
                </div>
            </div>

            <!-- Real Usage Analytics from Mock Data -->
            <div class="grid grid-2">
                <div class="card">
                    <h3>üìà Usage Trends (Aug 2023 - Mar 2025)</h3>
                    <div style="margin: 15px 0;">
                        <p><strong>Data Period:</strong> 20 of 36 contract months (56% complete)</p>
                        <p><strong>Total Activity:</strong> 6,524 interactions</p>
                        <p><strong>Monthly Average:</strong> 326 interactions/month</p>
                        <p><strong>Document Downloads:</strong> 6,170 reports (309/month avg)</p>
                        <p><strong>Analyst Calls:</strong> 306 consultations (15/month avg)</p>
                        <p><strong>Conference Sessions:</strong> 48 attendances (2.4/month avg)</p>
                    </div>
                    <div class="chart-placeholder">
                        <div>
                            <i class="fas fa-chart-line" style="font-size: 36px; margin-bottom: 10px;"></i>
                            <p><strong>Projection:</strong> 11,747 total interactions by Jul 2026</p>
                            <p><strong>Growth Pattern:</strong> 23% increase from baseline trend</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>üë• Top User Analysis (20-month data)</h3>
                    <table class="table" style="font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Documents</th>
                                <th>Calls</th>
                                <th>Monthly Avg</th>
                                <th>Projected Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Ace Tan (CISO)</strong></td>
                                <td>1,749</td>
                                <td>47</td>
                                <td><strong>91/month</strong></td>
                                <td>3,276</td>
                            </tr>
                            <tr>
                                <td>Dom Chan</td>
                                <td>559</td>
                                <td>31</td>
                                <td>30/month</td>
                                <td>1,068</td>
                            </tr>
                            <tr>
                                <td>YZ Feng (CDAO)</td>
                                <td>300</td>
                                <td>22</td>
                                <td>16/month</td>
                                <td>593</td>
                            </tr>
                            <tr>
                                <td>Chan Vivi</td>
                                <td>261</td>
                                <td>0</td>
                                <td>13/month</td>
                                <td>473</td>
                            </tr>
                            <tr>
                                <td>Wang JH</td>
                                <td>209</td>
                                <td>13</td>
                                <td>11/month</td>
                                <td>400</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="font-size: 0.85rem; color: #64748b; margin-top: 10px;">
                        Projected totals based on current 20-month usage patterns
                    </p>
                </div>
            </div>

            <!-- Service Plan Utilization Analysis -->
            <div class="card">
                <h3>üìä Service Plan Utilization & Restructuring Analysis</h3>
                <div class="grid grid-3">
                    <div>
                        <h4>Gartner for CISOs</h4>
                        <p><strong>Users:</strong> 1 (Ace Tan)</p>
                        <p><strong>Total Activity:</strong> 1,810 interactions</p>
                        <p><strong>Per-User Avg:</strong> 1,810/user</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%; background: #059669;"></div>
                        </div>
                        <span class="badge badge-success">Exceptional Value</span>
                        <p style="font-size: 0.85rem; margin-top: 8px;"><strong>Analysis:</strong> Single power user with extreme high usage (91 interactions/month)</p>
                    </div>
                    <div>
                        <h4>Executive Programs</h4>
                        <p><strong>Users:</strong> 6 (Leadership Team)</p>
                        <p><strong>Total Activity:</strong> 1,459 interactions</p>
                        <p><strong>Per-User Avg:</strong> 243/user</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%; background: #d97706;"></div>
                        </div>
                        <span class="badge badge-warning">Mixed Performance</span>
                        <p style="font-size: 0.85rem; margin-top: 8px;"><strong>Analysis:</strong> High variance - Dom Chan (591) vs others (~50-300)</p>
                    </div>
                    <div>
                        <h4>Technical Professionals (GTP)</h4>
                        <p><strong>Users:</strong> 24 (SMB EA team)</p>
                        <p><strong>Total Activity:</strong> 1,847 interactions</p>
                        <p><strong>Per-User Avg:</strong> 77/user</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 20%; background: #dc2626;"></div>
                        </div>
                        <span class="badge badge-danger">Needs Restructuring</span>
                        <p style="font-size: 0.85rem; margin-top: 8px;"><strong>Analysis:</strong> Low per-user utilization suggests over-provisioning</p>
                    </div>
                </div>
            </div>

            <!-- Outlier Detection & Usage Patterns -->
            <div class="card">
                <h3>üîç Unusual Usage Patterns & Outlier Analysis</h3>
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Extreme Usage Outliers Detected:</strong> Significant variance in user behavior patterns requiring immediate attention
                </div>
                
                <div class="grid grid-2">
                    <div>
                        <h4>üìä Usage Distribution Analysis</h4>
                        <table class="table" style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>User Category</th>
                                    <th>Users</th>
                                    <th>Avg Activity</th>
                                    <th>% of Total Usage</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: rgba(220, 38, 38, 0.05);">
                                    <td><strong>Extreme Outlier</strong></td>
                                    <td>1</td>
                                    <td>1,810</td>
                                    <td>28%</td>
                                    <td><span class="badge badge-danger">Investigate</span></td>
                                </tr>
                                <tr style="background: rgba(217, 119, 6, 0.05);">
                                    <td><strong>High Users</strong></td>
                                    <td>4</td>
                                    <td>295</td>
                                    <td>18%</td>
                                    <td><span class="badge badge-warning">Monitor</span></td>
                                </tr>
                                <tr style="background: rgba(5, 150, 105, 0.05);">
                                    <td><strong>Active Users</strong></td>
                                    <td>8</td>
                                    <td>89</td>
                                    <td>11%</td>
                                    <td><span class="badge badge-success">Optimal</span></td>
                                </tr>
                                <tr style="background: rgba(220, 38, 38, 0.05);">
                                    <td><strong>Low Users</strong></td>
                                    <td>25</td>
                                    <td>17</td>
                                    <td>6%</td>
                                    <td><span class="badge badge-danger">Under-utilized</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4>üö® Critical Outlier: Ace Tan</h4>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li><strong>1,749 documents</strong> (28% of all downloads)</li>
                            <li><strong>47 analyst calls</strong> (15% of all calls)</li>
                            <li><strong>14 conferences</strong> (29% of all attendance)</li>
                            <li><strong>91 interactions/month</strong> vs 8.6 avg</li>
                            <li><strong>Cost driver:</strong> ~$1.1M attributable spend</li>
                        </ul>
                        <div class="alert alert-danger" style="margin-top: 15px;">
                            <strong>Analysis:</strong> Single user consuming nearly 30% of total contract value. Requires investigation for business justification or potential account sharing.
                        </div>
                    </div>
                </div>

                <!-- Zero/Low Usage Analysis -->
                <h4 style="margin-top: 25px;">üìâ Zero & Low Usage Analysis</h4>
                <div class="grid grid-2">
                    <div>
                        <h5>Zero Usage Users (Potential Seat Recovery)</h5>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9rem;">
                            <li><strong>Andrew Ng:</strong> 43 docs only, no calls/conferences</li>
                            <li><strong>Frank Liew:</strong> 36 docs only</li>
                            <li><strong>Lee HW:</strong> 45 docs only</li>
                            <li><strong>Farmer Nield:</strong> 97 docs only</li>
                            <li><strong>Multiple GTP users:</strong> 7-47 docs, no other activity</li>
                        </ul>
                        <p><strong>Recommendation:</strong> Review 15+ users with <50 total interactions</p>
                    </div>
                    <div>
                        <h5>Unusual Activity Patterns</h5>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9rem;">
                            <li><strong>Chan Vivi:</strong> 261 docs, 0 calls - research-only usage</li>
                            <li><strong>GPD Ng:</strong> 72 docs, 36 calls - high call:doc ratio</li>
                            <li><strong>Sally:</strong> 174 docs, 7 calls, 1 conference - balanced but high volume</li>
                            <li><strong>YZ Feng:</strong> Multiple conference attendance (7) vs others</li>
                        </ul>
                        <p><strong>Recommendation:</strong> Investigate high-call users for potential plan optimization</p>
                    </div>
                </div>
            </div>

            <!-- Restructuring Recommendations -->
            <div class="card">
                <h3>üîÑ Seat Restructuring Recommendations</h3>
                <div class="grid grid-2">
                    <div>
                        <h4>Current State Analysis</h4>
                        <table class="table">
                            <tr>
                                <td>Total Users:</td>
                                <td>38</td>
                            </tr>
                            <tr>
                                <td>High-Value Users (>200 interactions):</td>
                                <td>5 (13%)</td>
                            </tr>
                            <tr>
                                <td>Active Users (50-200 interactions):</td>
                                <td>8 (21%)</td>
                            </tr>
                            <tr>
                                <td>Low-Value Users (<50 interactions):</td>
                                <td>25 (66%)</td>
                            </tr>
                            <tr>
                                <td>Effective Utilization Rate:</td>
                                <td>34% (13 active of 38)</td>
                            </tr>
                        </table>
                    </div>
                    <div>
                        <h4>Recommended Restructuring</h4>
                        <div class="alert alert-success">
                            <strong>Tiered Access Model:</strong>
                        </div>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li><strong>Premium (5 users):</strong> Ace Tan, Dom Chan, YZ Feng, Chan Vivi, Wang JH</li>
                            <li><strong>Standard (8 users):</strong> Active users with 50-200 interactions</li>
                            <li><strong>Basic (10 users):</strong> Occasional users, limited access</li>
                            <li><strong>Remove (15 users):</strong> <25 interactions, minimal business value</li>
                        </ul>
                        <p><strong>Projected Savings:</strong> $1.2M annually through right-sizing</p>
                    </div>
                </div>
            </div>

            <!-- Survey Results from Your Data -->
            <div class="card">
                <h3>üìã User Feedback Summary (Based on Actual Survey)</h3>
                <div class="grid grid-3">
                    <div>
                        <h4>Focus 1: Gartner Value Assessment</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 76%;"></div>
                        </div>
                        <p><strong>76%</strong> rate Gartner as valuable</p>
                        <ul style="font-size: 0.9rem; margin: 10px 0;">
                            <li>High-value users: CISO, IT Leaders</li>
                            <li>Key benefit: Strategic decision support</li>
                            <li>Most used: Magic Quadrants, Market Guides</li>
                        </ul>
                        <span class="badge badge-success">Strong Satisfaction</span>
                    </div>
                    <div>
                        <h4>Focus 2: Alternative Providers</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 31%;"></div>
                        </div>
                        <p><strong>31%</strong> interested in alternatives</p>
                        <ul style="font-size: 0.9rem; margin: 10px 0;">
                            <li>Primary reason: Cost concerns</li>
                            <li>Preferred alternative: Forrester (18%)</li>
                            <li>Concerns: Content gaps, transition effort</li>
                        </ul>
                        <span class="badge badge-warning">Monitor Interest</span>
                    </div>
                    <div>
                        <h4>Focus 3: Future Direction</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 69%;"></div>
                        </div>
                        <p><strong>69%</strong> support optimized renewal</p>
                        <ul style="font-size: 0.9rem; margin: 10px 0;">
                            <li>Preference: Right-sized seat allocation</li>
                            <li>Priority: Maintain analyst access</li>
                            <li>Contract: 2-3 year terms preferred</li>
                        </ul>
                        <span class="badge badge-success">Renewal Support</span>
                    </div>
                </div>
            </div>

            <!-- Usage Pattern Insights -->
            <div class="card">
                <h3>üîç Key Usage Insights from 20-Month Period</h3>
                <div class="grid grid-2">
                    <div class="alert alert-success">
                        <h5><strong>Consistent Engagement:</strong> 326 Interactions/Month</h5>
                        <p>Steady usage across 20-month period with 23% growth trend. Peak activity during budget cycles (Sep 2023, Mar 2024) shows strategic timing alignment.</p>
                    </div>
                    <div class="alert alert-info">
                        <h5><strong>Power User Sustainability:</strong> High Monthly Averages</h5>
                        <p>Ace Tan's 91 interactions/month over 20 months demonstrates sustained high-value usage. Top 5 users maintain consistent engagement patterns.</p>
                    </div>
                </div>
                <div class="grid grid-2" style="margin-top: 15px;">
                    <div class="alert alert-warning">
                        <h5><strong>Conference Utilization:</strong> 2.4 Sessions/Month</h5>
                        <p>Low conference attendance (48 total) suggests preference for direct analyst access. May indicate conference scheduling or accessibility issues.</p>
                    </div>
                    <div class="alert alert-success">
                        <h5><strong>Analyst Call Frequency:</strong> 15 Calls/Month</h5>
                        <p>306 total analyst calls show strong engagement with premium services. 15 calls/month indicates regular strategic consultation usage.</p>
                    </div>
                </div>
            </div>

            <!-- Current Contract Performance -->
            <div class="card">
                <h3>üí∞ Contract Performance vs Budget</h3>
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Budget Variance Alert:</strong> Actual spending $3.9M vs $3.5M contracted (11% over budget)
                </div>
                <div class="grid grid-2">
                    <div>
                        <h4>GT (Government Technology) Segment</h4>
                        <table class="table">
                            <tr>
                                <td>Contracted (3-year):</td>
                                <td><strong>$2.8M</strong></td>
                            </tr>
                            <tr>
                                <td>Actual to Date:</td>
                                <td><strong style="color: #dc2626;">$3.1M</strong></td>
                            </tr>
                            <tr>
                                <td>Variance:</td>
                                <td><span class="badge badge-danger">+$300K (11% over)</span></td>
                            </tr>
                            <tr>
                                <td>Usage (Documents):</td>
                                <td>4,938 downloads</td>
                            </tr>
                        <tr>
                            <tr>
                                <td>Cost per Download:</td>
                                <td><strong>$632</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div>
                        <h4>SNDGO (Smart Nation & Digital Gov) Segment</h4>
                        <table class="table">
                            <tr>
                                <td>Contracted (3-year):</td>
                                <td><strong>$0.7M</strong></td>
                            </tr>
                            <tr>
                                <td>Actual to Date:</td>
                                <td><strong style="color: #dc2626;">$0.8M</strong></td>
                            </tr>
                            <tr>
                                <td>Variance:</td>
                                <td><span class="badge badge-danger">+$100K (14% over)</span></td>
                            </tr>
                            <tr>
                                <td>Usage (Documents):</td>
                                <td>1,232 downloads</td>
                            </tr>
                            <tr>
                                <td>Cost per Download:</td>
                                <td><strong>$649</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Budget Analysis -->
            <div class="card">
                <h3>üìà Contract Budget Analysis (20 months into 36-month term)</h3>
                <div class="grid grid-3">
                    <div style="text-align: center; padding: 15px; background: rgba(220, 38, 38, 0.05); border-radius: 8px;">
                        <h4 style="color: #dc2626; margin-bottom: 10px;">$3.9M</h4>
                        <p><strong>Actual Spend (20 months)</strong></p>
                        <p style="font-size: 0.9rem; color: #64748b;">vs $1.95M expected pace</p>
                        <span class="badge badge-danger">100% Over Pace</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(220, 38, 38, 0.05); border-radius: 8px;">
                        <h4 style="color: #dc2626; margin-bottom: 10px;">$632</h4>
                        <p><strong>Cost per Download</strong></p>
                        <p style="font-size: 0.9rem; color: #64748b;">$3.9M √∑ 6,170 downloads</p>
                        <span class="badge badge-danger">Very High Cost</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(217, 119, 6, 0.05); border-radius: 8px;">
                        <h4 style="color: #d97706; margin-bottom: 10px;">$7.02M</h4>
                        <p><strong>Projected Final Cost</strong></p>
                        <p style="font-size: 0.9rem; color: #64748b;">If current pace continues</p>
                        <span class="badge badge-warning">Budget Crisis</span>
                    </div>
                </div>
            </div>

            <!-- Usage Efficiency Analysis -->
            <div class="card">
                <h3>‚öñÔ∏è Cost Efficiency by Segment</h3>
                <div class="alert alert-info">
                    <strong>Critical Cost Analysis:</strong> At $632 per download, each report costs more than many professional services. However, this includes analyst access, conferences, and strategic advisory value beyond just document downloads.
                </div>
                <div class="grid grid-2">
                    <div>
                        <h4>GT Segment Performance</h4>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li><strong>Usage Share:</strong> 80% of total downloads (4,938/6,170)</li>
                            <li><strong>Cost per Download:</strong> $628 ($3.1M √∑ 4,938)</li>
                            <li><strong>Budget Performance:</strong> 11% over contracted amount</li>
                            <li><strong>Value Beyond Downloads:</strong> Includes 245 analyst calls, 38 conferences</li>
                        </ul>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 80%; background: #1e40af;"></div>
                        </div>
                        <p style="text-align: center; margin-top: 5px;">80% Usage Share</p>
                    </div>
                    <div>
                        <h4>SNDGO Segment Performance</h4>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li><strong>Usage Share:</strong> 20% of total downloads (1,232/6,170)</li>
                            <li><strong>Cost per Download:</strong> $649 ($0.8M √∑ 1,232)</li>
                            <li><strong>Budget Performance:</strong> 14% over contracted amount</li>
                            <li><strong>Value Beyond Downloads:</strong> Includes 61 analyst calls, 10 conferences</li>
                        </ul>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 20%; background: #059669;"></div>
                        </div>
                        <p style="text-align: center; margin-top: 5px;">20% Usage Share</p>
                    </div>
                </div>
            </div>

            <!-- Financial Impact Summary -->
            <div class="card" style="border-left: 4px solid #dc2626;">
                <h3>üö® Financial Impact Analysis</h3>
                <div style="background: #fef2f2; padding: 20px; border-radius: 6px;">
                    <div class="grid grid-2">
                        <div>
                            <h4 style="color: #dc2626;">Budget Overrun Drivers</h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Higher than expected usage by power users</li>
                                <li>Additional seats/upgrades beyond original contract</li>
                                <li>Price escalations or scope changes</li>
                                <li>Both GT and SNDGO segments exceeded projections</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: #dc2626;">Renewal Implications</h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Budget Reality:</strong> Need $3.9M+ for similar usage</li>
                                <li><strong>Cost Control:</strong> Implement usage monitoring</li>
                                <li><strong>Contract Structure:</strong> Add spend caps or volume limits</li>
                                <li><strong>ROI Focus:</strong> Justify spend with value metrics</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-warning" style="margin: 20px 0 0 0;">
                        <strong>Critical Contract Analysis:</strong> 20 months into a 36-month contract, spending is 101% over the expected pace. Without intervention, the contract could cost $7.02M vs $3.5M budgeted - requiring immediate budget review and spend controls.
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Insights Engine -->
        <div id="insights" class="tab-content">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Management Summary:</strong> Key insights to guide procurement decisions and budget optimization
            </div>

            <!-- Executive Value Assessment -->
            <div class="card">
                <h3>üí∞ Value vs Cost Analysis</h3>
                <div class="grid grid-2">
                    <div>
                        <h4>Are Users Getting Value?</h4>
                        <div class="alert alert-success">
                            <strong>‚úÖ YES - Strong Value Perception</strong><br>
                            ‚Ä¢ 78% of users rate Gartner as "useful" or "very useful"<br>
                            ‚Ä¢ High engagement: 73% utilization rate vs 64% industry average<br>
                            ‚Ä¢ Users actively consume content (avg 8.2 downloads/month per active user)
                        </div>
                        
                        <h4>Does Value Justify Cost?</h4>
                        <div class="alert alert-success">
                            <strong>‚úÖ YES - Positive ROI Demonstrated</strong><br>
                            ‚Ä¢ Cost per insight: $285 vs $370 industry benchmark<br>
                            ‚Ä¢ Estimated value generated: $3.4M vs $2.4M spent<br>
                            ‚Ä¢ ROI calculation: 4.2:1 return on investment
                        </div>
                    </div>
                    <div>
                        <h4>Budget Optimization Opportunities</h4>
                        <div class="alert alert-info">
                            <strong>üí° OPTIMIZATION POTENTIAL: $420K Annual Savings</strong><br>
                            ‚Ä¢ 27% of seats show low utilization (<2 downloads/month)<br>
                            ‚Ä¢ Right-size to 620 active seats from current 847<br>
                            ‚Ä¢ Maintain service quality while reducing costs
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>Recommended Actions:</h5>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Immediate:</strong> Reduce seat count by 227 seats</li>
                                <li><strong>Contract:</strong> Negotiate 2-year deal for better pricing</li>
                                <li><strong>Focus:</strong> Concentrate spend on high-value content areas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Pattern Insights -->
            <div class="card">
                <h3>üìä Usage Patterns - What They Tell Us About Buying Strategy</h3>
                <div class="grid grid-3">
                    <div class="insight-card">
                        <h5>üéØ Peak Usage Patterns</h5>
                        <strong>Finding:</strong> 67% of usage occurs during Q1 budget planning and Q3 strategy cycles<br>
                        <strong>Implication:</strong> Users rely heavily on Gartner for critical business decisions<br>
                        <strong>Buying Strategy:</strong> Essential service - maintain access during peak periods
                    </div>
                    <div class="insight-card">
                        <h5>üèÜ High-Value User Segments</h5>
                        <strong>Finding:</strong> IT Leadership and Strategy teams drive 64% of total value<br>
                        <strong>Implication:</strong> Clear power users with measurable business impact<br>
                        <strong>Buying Strategy:</strong> Prioritize premium access for these departments
                    </div>
                    <div class="insight-card">
                        <h5>üìà Content Preference Analysis</h5>
                        <strong>Finding:</strong> Magic Quadrants & Market Guides = 73% of perceived value<br>
                        <strong>Implication:</strong> Specific content types drive most business decisions<br>
                        <strong>Buying Strategy:</strong> Focus contract on high-impact research areas
                    </div>
                </div>
            </div>

            <!-- Department Analysis -->
            <div class="card">
                <h3>üè¢ Department-Level Value Analysis</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th>Seats Allocated</th>
                            <th>Active Users</th>
                            <th>Utilization Rate</th>
                            <th>Value Generated</th>
                            <th>Cost per Value</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: rgba(5, 150, 105, 0.05);">
                            <td><strong>Strategy & Planning</strong></td>
                            <td>45</td>
                            <td>42</td>
                            <td><span class="badge badge-success">93%</span></td>
                            <td>$1,200,000</td>
                            <td>$147</td>
                            <td><span class="badge badge-success">Optimize - High Value</span></td>
                        </tr>
                        <tr style="background: rgba(5, 150, 105, 0.05);">
                            <td><strong>IT Leadership</strong></td>
                            <td>67</td>
                            <td>58</td>
                            <td><span class="badge badge-success">87%</span></td>
                            <td>$980,000</td>
                            <td>$163</td>
                            <td><span class="badge badge-success">Maintain - Core User</span></td>
                        </tr>
                        <tr style="background: rgba(217, 119, 6, 0.05);">
                            <td>Business Development</td>
                            <td>89</td>
                            <td>52</td>
                            <td><span class="badge badge-warning">58%</span></td>
                            <td>$420,000</td>
                            <td>$284</td>
                            <td><span class="badge badge-warning">Right-size to 55 seats</span></td>
                        </tr>
                        <tr style="background: rgba(217, 119, 6, 0.05);">
                            <td>Operations</td>
                            <td>156</td>
                            <td>87</td>
                            <td><span class="badge badge-warning">56%</span></td>
                            <td>$380,000</td>
                            <td>$312</td>
                            <td><span class="badge badge-warning">Reduce to 95 seats</span></td>
                        </tr>
                        <tr style="background: rgba(220, 38, 38, 0.05);">
                            <td>Support Functions</td>
                            <td>490</td>
                            <td>143</td>
                            <td><span class="badge badge-danger">29%</span></td>
                            <td>$180,000</td>
                            <td>$543</td>
                            <td><span class="badge badge-danger">Major reduction to 150 seats</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Strategic Recommendations -->
            <div class="card">
                <h3>üéØ Strategic Purchasing Recommendations</h3>
                <div class="grid grid-2">
                    <div>
                        <h4>Contract Structure Optimization</h4>
                        <div class="alert alert-success">
                            <strong>Recommended Approach: Tiered Access Model</strong>
                        </div>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li><strong>Tier 1 (Premium):</strong> 145 seats for Strategy & IT Leadership</li>
                            <li><strong>Tier 2 (Standard):</strong> 285 seats for active business users</li>
                            <li><strong>Tier 3 (Basic):</strong> 190 seats for occasional users</li>
                        </ul>
                        <p><strong>Expected Savings:</strong> $420,000 annually vs current structure</p>
                    </div>
                    <div>
                        <h4>Contract Terms Strategy</h4>
                        <div class="alert alert-info">
                            <strong>Optimal Contract Length: 2 Years</strong>
                        </div>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li><strong>Volume Discount:</strong> 8% reduction for 2-year commitment</li>
                            <li><strong>Flexibility:</strong> Annual seat adjustment clause (¬±10%)</li>
                            <li><strong>Performance:</strong> SLA guarantees with service credits</li>
                            <li><strong>Price Protection:</strong> Cap annual increases at 3%</li>
                        </ul>
                        <p><strong>Total Value:</strong> $287K additional savings over contract term</p>
                    </div>
                </div>
            </div>

            <!-- Alternative Analysis -->
            <div class="card">
                <h3>‚öñÔ∏è Alternative Provider Assessment</h3>
                <div class="grid grid-3">
                    <div class="alert alert-success">
                        <h5>Gartner (Current)</h5>
                        <strong>Strengths:</strong><br>
                        ‚Ä¢ Established user adoption (78% satisfaction)<br>
                        ‚Ä¢ Comprehensive Magic Quadrant coverage<br>
                        ‚Ä¢ Strong analyst access (47 calls annually)<br>
                        <strong>Value Score: 8.4/10</strong>
                    </div>
                    <div class="alert alert-info">
                        <h5>Forrester Alternative</h5>
                        <strong>Potential Benefits:</strong><br>
                        ‚Ä¢ 15% cost reduction ($360K savings)<br>
                        ‚Ä¢ Strong in customer experience research<br>
                        ‚Ä¢ Good mobile platform<br>
                        <strong>Risks:</strong> 6-month transition period<br>
                        <strong>Value Score: 7.8/10</strong>
                    </div>
                    <div class="alert alert-info">
                        <h5>Hybrid Approach</h5>
                        <strong>Strategic Option:</strong><br>
                        ‚Ä¢ Gartner for IT/Strategy (400 seats)<br>
                        ‚Ä¢ Forrester for Marketing/CX (200 seats)<br>
                        ‚Ä¢ 12% overall cost reduction<br>
                        <strong>Complexity:</strong> Dual vendor management<br>
                        <strong>Value Score: 8.1/10</strong>
                    </div>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="card" style="border-left: 4px solid #1e40af;">
                <h3>üìã Executive Summary for Management Decision</h3>
                <div style="background: #f8fafc; padding: 20px; border-radius: 6px;">
                    <h4 style="color: #1e40af; margin-bottom: 15px;">Key Findings:</h4>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>Value Confirmation:</strong> Users perceive strong value (78% satisfaction) and ROI is positive (4.2:1)</li>
                        <li><strong>Cost Optimization:</strong> $420K annual savings opportunity through smart seat reallocation</li>
                        <li><strong>Usage Insights:</strong> Clear power user segments suggest tiered purchasing strategy</li>
                        <li><strong>Purchasing Strategy:</strong> 2-year tiered contract delivers optimal value and flexibility</li>
                    </ul>
                    
                    <h4 style="color: #1e40af; margin: 20px 0 15px 0;">Management Recommendation:</h4>
                    <div class="alert alert-success" style="margin: 0;">
                        <strong>PROCEED with optimized Gartner renewal</strong><br>
                        ‚Ä¢ Restructure to tiered access model (620 total seats)<br>
                        ‚Ä¢ Negotiate 2-year contract with performance guarantees<br>
                        ‚Ä¢ Achieve $707K total savings over contract period<br>
                        ‚Ä¢ Maintain service quality for critical business functions
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: AI Discovery Bot -->
<!--        <div id="ai-discovery" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Quick Questions</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-secondary" style="background-color: blue;" onclick="askQuestion('Show me Top 5 Users with highest ROI')">
                            Show me Top 5 Users with highest ROI
                        </button>
                        <button class="btn btn-secondary" onclick="askQuestion('What alternatives do users prefer?')">
                            What alternatives do users prefer?
                        </button>
                        <button class="btn btn-secondary" style="background-color: blue;" onclick="askQuestion('Low Usage Pattern Analysis')">
                            Low Usage Pattern Analysis
                        </button>
                        <button class="btn btn-secondary" onclick="askQuestion('Which content types drive most value?')">
                            Which content types drive most value?
                        </button>
                        <button class="btn btn-secondary" onclick="askQuestion('Compare our usage to industry benchmarks')">
                            Compare our usage to industry benchmarks
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h3>AI Chat Interface</h3>
                    <div class="chat-interface">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message message-bot">
                                <strong>AI Assistant:</strong> Hello! I can help you explore your Gartner contract data. Ask me anything about usage patterns, costs, user satisfaction, or comparisons with alternatives.
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" class="form-control" placeholder="Ask me about your Gartner data..." onkeypress="handleChatEnter(event)">
                            <button class="btn" onclick="sendChatMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>  -->

            <!-- Generated Insights -->
            <div class="card" id="generatedInsights" style="display: none;">
                <h3>Generated Analysis</h3>
                <div id="insightContent">
                    <!-- Dynamic content will appear here -->
                </div>
                <button class="btn btn-success" onclick="exportInsight()">
                    <i class="fas fa-download"></i> Export Analysis
                </button>
            </div>
        </div>

        <!-- Tab 4: Decision Optimizer -->
        <div id="optimizer" class="tab-content">
            <!-- Scenario Planning -->
            <div class="card">
                <h3>Scenario Planning Tool</h3>
                <div class="grid grid-2">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Budget Constraint: <span id="budgetConstraintValue">$5,000,000</span></label>
                            <input type="range" class="form-control" id="budgetConstraint" min="0" max="10000000" value="5000000" oninput="updateScenarios()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seat Allocation Strategy: <span id="seatStrategyValue">500</span> seats</label>
                            <input type="range" class="form-control" id="seatStrategy" min="0" max="1000" value="500" oninput="updateScenarios()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contract Term: <span id="contractTermValue">2</span> years</label>
                            <input type="range" class="form-control" id="contractTerm" min="0" max="5" value="2" oninput="updateScenarios()">
                        </div>
                    </div>
                    <div id="scenarioResults">
                        <h4>Scenario Analysis Results</h4>
                        <div class="alert alert-success">
                            <strong>Recommended:</strong> 2-year contract with optimized seat allocation
                            <br><strong>Savings:</strong> $420K annually
                            <br><strong>Risk Level:</strong> Low
                        </div>
                        <div class="chart-placeholder" style="height: 200px;">
                            <div>
                                <i class="fas fa-calculator" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p>Cost comparison across scenarios</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PQ Ratio Calculator -->
            <div class="card">
                <h3>Price-Quality Ratio Calculator</h3>
                <div class="grid grid-3">
                    <div>
                        <h4>Weighting Factors</h4>
                        <div class="form-group">
                            <label class="form-label">Content Quality: <span id="qualityWeightLabel">40</span>%</label>
                            <input type="range" class="form-control" min="0" max="100" value="40" id="qualityWeight" oninput="updatePQRatio()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cost Effectiveness: <span id="costWeightLabel">35</span>%</label>
                            <input type="range" class="form-control" min="0" max="100" value="35" id="costWeight" oninput="updatePQRatio()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">User Experience: <span id="uxWeightLabel">25</span>%</label>
                            <input type="range" class="form-control" min="0" max="100" value="25" id="uxWeight" oninput="updatePQRatio()">
                        </div>
                    </div>
                    <div class="provider-inputs">
                        <h4>Provider Metrics</h4>
                        <!-- Gartner -->
                        <h5>Gartner</h5>
                        <div class="form-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="gartnerPrice" value="2400000" oninput="updatePQRatio()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quality Score: <span id="gartnerQualityLabel">85</span></label>
                            <input type="range" class="form-control" id="gartnerQuality" value="85" oninput="updatePQRatio()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">UX Score: <span id="gartnerUxLabel">80</span></label>
                            <input type="range" class="form-control" id="gartnerUx" value="80" oninput="updatePQRatio()">
                        </div>
                        <!-- Forrester -->
                        <h5>Forrester</h5>
                        <div class="form-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="forresterPrice" value="2100000" oninput="updatePQRatio()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quality Score: <span id="forresterQualityLabel">80</span></label>
                            <input type="range" class="form-control" id="forresterQuality" value="80" oninput="updatePQRatio()">
                        </div>
                         <div class="form-group">
                            <label class="form-label">UX Score: <span id="forresterUxLabel">85</span></label>
                            <input type="range" class="form-control" id="forresterUx" value="85" oninput="updatePQRatio()">
                        </div>
                        <!-- IDC -->
                        <h5>IDC</h5>
                        <div class="form-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="idcPrice" value="1800000" oninput="updatePQRatio()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quality Score: <span id="idcQualityLabel">75</span></label>
                            <input type="range" class="form-control" id="idcQuality" value="75" oninput="updatePQRatio()">
                        </div>
                         <div class="form-group">
                            <label class="form-label">UX Score: <span id="idcUxLabel">70</span></label>
                            <input type="range" class="form-control" id="idcUx" value="70" oninput="updatePQRatio()">
                        </div>
                    </div>
                    <div>
                        <h4>Provider Comparison</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Provider</th>
                                    <th>PQ Score</th>
                                    <th>Ranking</th>
                                </tr>
                            </thead>
                            <tbody id="pqTable">
                                <!-- Calculated results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Risk Assessment -->
            <div class="card">
                <h3>Risk Assessment Matrix</h3>
                <div class="grid grid-3">
                    <div class="alert alert-success">
                        <strong>Low Risk:</strong> Continue current contract
                        <br>Probability: 85%
                        <br>Impact: Minimal disruption
                    </div>
                    <div class="alert alert-info">
                        <strong>Medium Risk:</strong> Switch to alternative
                        <br>Probability: 65%
                        <br>Impact: Transition costs, learning curve
                    </div>
                    <div class="alert alert-info">
                        <strong>Medium Risk:</strong> Hybrid approach
                        <br>Probability: 70%
                        <br>Impact: Management complexity
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: Report Generator -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h3>EC Report Template Generator</h3>
                <div class="form-group">
                    <label class="form-label">Report Type</label>
                    <select class="form-control" id="reportType" onchange="updateReportTemplate()">
                        <option value="tac-b">TEC "B" Approval Report</option>
                        <option value="renewal">Contract Renewal Analysis</option>
                        <option value="comparison">Provider Comparison Study</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Include Sections</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" checked> Executive Summary</label>
                        <label><input type="checkbox" checked> Usage Analysis</label>
                        <label><input type="checkbox" checked> Cost-Benefit Analysis</label>
                        <label><input type="checkbox" checked> Risk Assessment</label>
                        <label><input type="checkbox" checked> Recommendations</label>
                        <label><input type="checkbox"> Detailed Metrics</label>
                        <label><input type="checkbox"> Survey Results</label>
                        <label><input type="checkbox"> Benchmarking</label>
                    </div>
                </div>
            </div>

            <!-- Report Preview -->
            <div class="card">
                <h3>Report Preview</h3>
                <div id="reportPreview" style="border: 1px solid var(--border); padding: 20px; background: var(--surface); border-radius: 6px;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">Tender Evaluation Committee "B" - Gartner Research Services</h2>

                    <h3>Executive Summary</h3>
                    <p>Based on comprehensive analysis of usage data, user feedback, and market comparisons, this report recommends continuation of Gartner research services with optimized seat allocation. The analysis demonstrates strong ROI with a 4.2:1 return on investment and high user satisfaction scores.</p>

                    <h3>Key Findings</h3>
                    <ul>
                        <li><strong>Utilization:</strong> 73% active usage rate across 38 allocated seats</li>
                        <li><strong>Value Generation:</strong> $3.4M in quantified benefits against $2.4M cost</li>
                        <li><strong>User Satisfaction:</strong> 4.2/5 average rating with 78% finding service useful</li>
                        <li><strong>Cost Efficiency:</strong> 23% below industry average cost per insight</li>
                    </ul>

                    <h3>Recommendation</h3>
                    <div class="alert alert-success">
                        <strong>Approve 2-year contract renewal with optimized 38 seat allocation</strong>
                        <br>Projected annual savings: $420,000
                        <br>Maintained service quality with improved cost efficiency
                    </div>

                    <p style="margin-top: 20px; color: var(--text-muted); font-style: italic;">
                        This report includes comprehensive data backing, risk analysis, and audit trails as required for government procurement compliance.
                    </p>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn">
                        <i class="fas fa-file-word"></i> Export to Word
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-file-pdf"></i> Export to PDF
                    </button>
                    <button class="btn btn-success">
                        <i class="fas fa-share"></i> Submit for Approval
                    </button>
                </div>
            </div>

            <!-- Approval Workflow -->
            <div class="card">
                <h3>Approval Workflow Status</h3>
                <div class="grid grid-4">
                    <div style="text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                        <p><strong>Draft Complete</strong></p>
                        <p style="font-size: 0.9rem; color: var(--text-muted);">Ready for review</p>
                    </div>
                    <div style="text-align: center;">
                        <i class="fas fa-clock" style="font-size: 2rem; color: var(--warning); margin-bottom: 10px;"></i>
                        <p><strong>Legal Review</strong></p>
                        <p style="font-size: 0.9rem; color: var(--text-muted);">Pending</p>
                    </div>
                    <div style="text-align: center;">
                        <i class="fas fa-clock" style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                        <p><strong>EC Approval</strong></p>
                        <p style="font-size: 0.9rem; color: var(--text-muted);">Waiting</p>
                    </div>
                    <div style="text-align: center;">
                        <i class="fas fa-clock" style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                        <p><strong>Final Execution</strong></p>
                        <p style="font-size: 0.9rem; color: var(--text-muted);">Waiting</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Navigation
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // AI Chat Functionality
        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            const thinkingMessage = addMessage('...', 'bot');
            
            try {
                const response = await fetch('/api/agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory, // Keep track of chat history
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') break;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.delta) {
                                    fullResponse += parsed.delta;
                                    // Update message with formatted response in real-time
                                    const formattedResponse = formatBotResponse(fullResponse);
                                    thinkingMessage.innerHTML = `<strong>AI Assistant:</strong> ${formattedResponse}`;
                                }
                                if (parsed.error) {
                                    thinkingMessage.innerHTML = `<strong>AI Assistant:</strong> Error: ${parsed.error}`;
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }
                
                // Save to chat history
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: fullResponse });
                
                showGeneratedInsights(message, fullResponse);
                
            } catch (error) {
                thinkingMessage.innerHTML = `<strong>AI Assistant:</strong> Sorry, I encountered an error: ${error.message}`;
            }
        }

 // Initialize chat history at the top of your script       
        let chatHistory = [];

        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function addMessage(text, type) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            if (type === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${text}`;
            } else {
                // Format the bot response with proper line breaks
                const formattedText = formatBotResponse(text);
                messageDiv.innerHTML = `<strong>dealBreaker AI Assistant:</strong><br> ${formattedText}`;
            }

            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            return messageDiv;
        }

        // New function to format bot responses
        function formatBotResponse(text) {
            return text
                // Convert markdown bold to HTML
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Add line break before each numbered item (but not the first one)
               // .replace(/([^\n])(\d+\.\s)/g, '$1<br><br>$2')
                .replace(/(?<![a-zA-Z0-9])(\d+\.\s)/g, '<br><br>$1')
                // Preserve any existing line breaks
                .replace(/\n/g, '<br>');
        }

        function generateAIResponse(question) {
            // In a real application, this is where you would make an API call
            // to a service like GitHub Copilot, OpenAI, or another AI provider.
            // For example:
            //
            // const response = await fetch('https://api.copilot.com/v1/chat', {
            //   method: 'POST',
            //   headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer YOUR_API_KEY' },
            //   body: JSON.stringify({ prompt: question })
            // });
            // const data = await response.json();
            // return data.choices[0].text;

            return new Promise(resolve => {
                setTimeout(() => {
                    const responses = {
                        'gartner vs forrester vs idc': `
                            <p>Here is a comparison of Gartner, Forrester, and IDC based on our analysis:</p>
                            <img src="q1_vendor_comparison.png" alt="Comparison Chart" style="width: 50%; border-radius: 6px; margin-top: 10px;">
                            <table class="table" style="margin-top: 15px; font-size: 0.9rem;">
                                <thead>
                                    <tr><th>Metric</th><th>Gartner</th><th>Forrester</th><th>IDC</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><strong>Cost per Report</strong></td><td>$632</td><td>$580</td><td>$710</td></tr>
                                    <tr><td><strong>Cost per Analyst Call</strong></td><td>$1,200</td><td>$1,500</td><td>$1,350</td></tr>
                                    <tr><td><strong>Best For</strong></td><td>Broad IT Strategy</td><td>Customer Experience</td><td>Market Sizing</td></tr>
                                </tbody>
                            </table>
                        `,
                        'top 5 users': `
                            <p>Based on the data, here are the top 5 users by interaction volume:</p>
                            <img src="top_5_users.png" alt="Top User Chart" style="width: 50%; border-radius: 6px; margin-top: 10px;">
                            <ol style="padding-left: 20px; margin-top: 15px;">
                                <li><strong>Ace Tan (CISO):</strong> 1,810 interactions (91/month)</li>
                                <li><strong>Dom Chan:</strong> 590 interactions (30/month)</li>
                                <li><strong>YZ Feng (CDAO):</strong> 322 interactions (16/month)</li>
                                <li><strong>Chan Vivi:</strong> 261 interactions (13/month)</li>
                                <li><strong>Wang JH:</strong> 222 interactions (11/month)</li>
                            </ol>
                        `,
                        'low usage': `
                            <p>Here are some of the users with the lowest engagement. This may represent an opportunity to recover licenses:</p>
                            <img src="low_usage.png" alt="Low Usage Chart" style="width: 50%; border-radius: 6px; margin-top: 10px;">
                            <ul style="padding-left: 20px; margin-top: 15px;">
                                <li><strong>Andrew Ng:</strong> 43 interactions (documents only)</li>
                                <li><strong>Frank Liew:</strong> 36 interactions (documents only)</li>
                                <li><strong>Lee HW:</strong> 45 interactions (documents only)</li>
                                <li><strong>Farmer Nield:</strong> 97 interactions (documents only)</li>
                                <li>Over 15 users have fewer than 50 total interactions.</li>
                            </ul>
                        `,
                        '2mil optimise': `
                            <p>To optimize for a $2 million budget, I recommend a tiered access model. This strategy maintains service for high-value users while significantly reducing costs.</p>
                            <img src="q4_budget_allocation.png" alt="Budget Chart" style="width: 50%; border-radius: 6px; margin-top: 10px;">
                            <h5 style="margin-top: 15px;">Recommended Tiered Model:</h5>
                            <ul style="padding-left: 20px; margin-top: 10px;">
                                <li><strong>Premium Tier (5 users):</strong> Full access for key leaders like Ace Tan, Dom Chan.</li>
                                <li><strong>Standard Tier (8 users):</strong> Access for active users with regular needs.</li>
                                <li><strong>Basic Tier (10 users):</strong> Limited access for occasional research.</li>
                                <li><strong>Remove (15 users):</strong> Reclaim licenses from users with minimal or no activity.</li>
                            </ul>
                            <p style="margin-top: 10px;">This approach could lead to projected annual savings of over <strong>$1.2M</strong>, fitting within the new budget while retaining core value.</p>
                        `
                    };

                    const questionText = question.toLowerCase();
                    for (let key in responses) {
                        // A simple keyword check. For a real bot, you'd use more sophisticated NLP.
                        if (questionText.includes(key)) {
                            resolve(responses[key]);
                            return;
                        }
                    }

                    resolve('Based on your data analysis, I can see strong patterns in usage and value generation. Your Gartner utilization shows above-average performance with good ROI metrics. Would you like me to dive deeper into any specific area?');
                }, 1000);
            });
        }

        function showGeneratedInsights(question, response) {
            const insights = document.getElementById('generatedInsights');
            const content = document.getElementById('insightContent');

            content.innerHTML = `
                <h4>Query: ${question}</h4>
                <div class="insight-card">
                    <p>${response}</p>
                </div>
                <div class="chart-placeholder" style="height: 200px;">
                    <div>
                        <i class="fas fa-chart-area" style="font-size: 36px; margin-bottom: 10px;"></i>
                        <p>Generated visualization for: ${question}</p>
                    </div>
                </div>
            `;

            insights.style.display = 'block';
        }

        function exportInsight() {
            alert('Insight analysis exported to Excel format with interactive charts and data tables.');
        }

        // Scenario Planning Updates
        function updateScenarios() {
            const budget = document.getElementById('budgetConstraint').value;
            const seats = document.getElementById('seatStrategy').value;
            const term = document.getElementById('contractTerm').value;

            // Update the value displays
            document.getElementById('budgetConstraintValue').textContent = '$' + new Intl.NumberFormat().format(budget);
            document.getElementById('seatStrategyValue').textContent = seats;
            document.getElementById('contractTermValue').textContent = term;

            const results = document.getElementById('scenarioResults');

            let recommendation = `Budget: $${new Intl.NumberFormat().format(budget)}, Seats: ${seats}, Term: ${term} years`;
            let savings = '$' + new Intl.NumberFormat().format(2400000 - (budget/5 * term) - (seats * 100 * term)); // Simplified savings calculation
            let risk = 'Medium';

            if (seats < 600) {
                risk = 'High';
            } else if (seats < 800) {
                risk = 'Medium';
            } else {
                risk = 'Low';
            }

            results.innerHTML = `
                <h4>Scenario Analysis Results</h4>
                <div class="alert alert-info">
                    <strong>Scenario:</strong> ${recommendation}
                    <br><strong>Estimated Savings:</strong> ${savings}
                    <br><strong>Risk Level:</strong> ${risk}
                </div>
                <div class="chart-placeholder" style="height: 200px;">
                    <div>
                        <i class="fas fa-calculator" style="font-size: 36px; margin-bottom: 10px;"></i>
                        <p>Updated cost comparison for selected scenario</p>
                    </div>
                </div>
            `;
        }

        // PQ Ratio Updates
        function updatePQRatio() {
            // Update weight labels
            const qualityWeight = parseInt(document.getElementById('qualityWeight').value);
            const costWeight = parseInt(document.getElementById('costWeight').value);
            const uxWeight = parseInt(document.getElementById('uxWeight').value);
            document.getElementById('qualityWeightLabel').textContent = qualityWeight;
            document.getElementById('costWeightLabel').textContent = costWeight;
            document.getElementById('uxWeightLabel').textContent = uxWeight;

            const providers = ['gartner', 'forrester', 'idc'];
            const providerData = {};

            let minPrice = Infinity, maxPrice = -Infinity;

            providers.forEach(p => {
                const price = parseInt(document.getElementById(`${p}Price`).value);
                if (price < minPrice) minPrice = price;
                if (price > maxPrice) maxPrice = price;

                providerData[p] = {
                    name: p.charAt(0).toUpperCase() + p.slice(1),
                    price: price,
                    quality: parseInt(document.getElementById(`${p}Quality`).value),
                    ux: parseInt(document.getElementById(`${p}Ux`).value),
                };
                // Update labels for provider scores
                document.getElementById(`${p}QualityLabel`).textContent = providerData[p].quality;
                document.getElementById(`${p}UxLabel`).textContent = providerData[p].ux;
            });

            const results = [];
            providers.forEach(p => {
                const data = providerData[p];
                // Normalize price: higher is worse, so we invert the score.
                const priceScore = (maxPrice - data.price) / (maxPrice - minPrice) * 100;

                const totalWeight = qualityWeight + costWeight + uxWeight;
                if (totalWeight === 0) {
                    results.push({ name: data.name, score: 0 });
                    return;
                }

                const score = (
                    (data.quality * qualityWeight) +
                    (priceScore * costWeight) +
                    (data.ux * uxWeight)
                ) / totalWeight;

                results.push({ name: data.name, score: score.toFixed(2) });
            });

            results.sort((a, b) => b.score - a.score);

            const table = document.getElementById('pqTable');
            table.innerHTML = '';
            results.forEach((r, index) => {
                const rank = index + 1;
                let badgeClass = 'badge-success';
                if (rank === 2) badgeClass = 'badge-warning';
                if (rank > 2) badgeClass = 'badge-danger';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${r.name}</strong></td>
                    <td><strong>${r.score}</strong></td>
                    <td><span class="badge ${badgeClass}">#${rank}</span></td>
                `;
                table.appendChild(row);
            });
        }

        // Report Template Updates
        function updateReportTemplate() {
            const reportType = document.getElementById('reportType').value;
            const preview = document.getElementById('reportPreview');

            let title = '';
            let summary = '';

            switch(reportType) {
                case 'tac-b':
                    title = 'Tender Evaluation Committee "B" - Gartner Research Services';
                    summary = 'Based on comprehensive analysis of usage data, user feedback, and market comparisons, this report recommends continuation of Gartner research services with optimized seat allocation.';
                    break;
                case 'renewal':
                    title = 'Contract Renewal Analysis - Gartner Research Services';
                    summary = 'This renewal analysis evaluates current contract performance against market alternatives and provides recommendations for future service continuation.';
                    break;
                case 'comparison':
                    title = 'Research Provider Comparison Study';
                    summary = 'Comprehensive comparison of research service providers including Gartner, Forrester, IDC, and other alternatives based on cost, quality, and user satisfaction metrics.';
                    break;
            }

            preview.innerHTML = `
                <h2 style="color: var(--primary); margin-bottom: 20px;">${title}</h2>

                <h3>Executive Summary</h3>
                <p>${summary} The analysis demonstrates strong ROI with a 4.2:1 return on investment and high user satisfaction scores.</p>

                <h3>Key Findings</h3>
                <ul>
                    <li><strong>Utilization:</strong> 73% active usage rate across 38 allocated seats</li>
                    <li><strong>Value Generation:</strong> $3.4M in quantified benefits against $2.4M cost</li>
                    <li><strong>User Satisfaction:</strong> 4.2/5 average rating with 78% finding service useful</li>
                    <li><strong>Cost Efficiency:</strong> 23% below industry average cost per insight</li>
                </ul>

                <h3>Recommendation</h3>
                <div class="alert alert-success">
                    <strong>Approve 2-year contract renewal with optimized 38 seat allocation</strong>
                    <br>Projected annual savings: $420,000
                    <br>Maintained service quality with improved cost efficiency
                </div>

                <p style="margin-top: 20px; color: var(--text-muted); font-style: italic;">
                    This report includes comprehensive data backing, risk analysis, and audit trails as required for government procurement compliance.
                </p>
            `;
        }

        // Initialize with some demo data
        document.addEventListener('DOMContentLoaded', function() {
            // Any initialization code can go here
            console.log('Gartner Contract Evaluation Platform loaded successfully');
            updatePQRatio();
            updateScenarios();
        });
    </script>


<!-- === Floating Chat Modal (v2) === -->
<style>
  .ai-fab { position: fixed; right: 24px; bottom: 24px; border: 1px solid #111; background:#fff; padding:12px 16px; border-radius:9999px; cursor:pointer; box-shadow: var(--shadow, 0 2px 8px rgba(0,0,0,.08)); }
  .ai-modal { position: fixed; right: 24px; bottom: 84px; width: 400px; max-height: 75vh; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 8px 30px rgba(0,0,0,.1); display:none; flex-direction: column; overflow: hidden; }
  .ai-modal.open { display:flex; }
  .ai-head { padding:12px 14px; border-bottom:1px solid #e5e7eb; font-weight:600; display:flex; justify-content:space-between; align-items:center; background:#f8fafc; }
  .ai-body { padding:14px; overflow:auto; flex:1; }
  .ai-foot { padding:10px; border-top:1px solid #e5e7eb; display:flex; gap:8px; align-items:center; }
  .ai-msg { padding:10px 12px; border-radius:10px; margin:6px 0; background:#f3f4f6; }
  .ai-msg.me { background:#1e40af; color:#fff; margin-left:auto; }
  .ai-token { display:inline; }
  .ai-row { display:flex; gap:8px; align-items:center; }
  .ai-small { font-size:12px; color:#6b7280; }
  .ai-kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; padding:2px 6px; border:1px solid #e5e7eb; border-radius:6px; background:#f8fafc; }
</style>
<div class="ai-fab" id="aiFab" aria-label="Open AI assistant">ai</div>
<div class="ai-modal" id="aiModal" role="dialog" aria-modal="true" aria-label="AI assistant">
  <div class="ai-head">
    <span>dealBreaker AI Assistant</span>
    <div class="ai-small">Press <span class="ai-kbd">Esc</span> to close</div>
  </div>
  <div class="ai-body" id="aiBody"></div>
  <div style="padding:8px 12px; display:flex; gap:8px; border-top:1px solid #f1f5f9; background:#fafafa;">
    <label class="ai-small">Temp <input id="aiTemp" type="number" step="0.1" min="0" max="2" value="0.7" style="width:60px;margin-left:6px;"></label>
    <label class="ai-small">MaxTokens <input id="aiMax" type="number" step="1" min="64" max="4096" value="800" style="width:80px;margin-left:6px;"></label>
    <button id="aiClear" class="ai-small" style="margin-left:auto;">Clear chat</button>
  </div>
  <div class="ai-foot">
    <input id="aiInput" class="form-control" placeholder="Ask about this dashboard‚Ä¶" style="flex:1"/>
    <button class="btn" id="aiSend">Send</button>
  </div>
</div>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const aiFab = $('#aiFab');
  const aiModal = $('#aiModal');
  const aiBody = $('#aiBody');
  const aiInput = $('#aiInput');
  const aiSend = $('#aiSend');
  const aiClear = $('#aiClear');
  const aiTemp = $('#aiTemp');
  const aiMax  = $('#aiMax');

  const STORE_KEY = 'ai_chat_history_v2';
  const MAX_TURNS = 12; // send last N messages (user+assistant pairs)

  function loadHistory(){
    try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch { return []; }
  }
  function saveHistory(arr){
    localStorage.setItem(STORE_KEY, JSON.stringify(arr.slice(-MAX_TURNS)));
  }
  function renderHistory(){
    aiBody.innerHTML = '';
    const hist = loadHistory();
    hist.forEach(m => addMsg(m.content, m.role === 'user'));
    aiBody.scrollTop = aiBody.scrollHeight;
  }

  function openModal(){ aiModal.classList.add('open'); aiInput.focus(); renderHistory(); }
  function closeModal(){ aiModal.classList.remove('open'); }
  aiFab?.addEventListener('click', openModal);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  function addMsg(content, me=false, isHtml=false){
    const div = document.createElement('div');
    div.className = 'ai-msg' + (me ? ' me' : '');
    div.innerHTML = isHtml ? content : formatMessage(content);
    aiBody.appendChild(div);
    aiBody.scrollTop = aiBody.scrollHeight;
    return div;
  }

  function pushHistory(role, content){
    const arr = loadHistory();
    arr.push({ role, content });
    saveHistory(arr);
  }

  async function send(){
    const text = aiInput.value.trim();
    if(!text) return;
    addMsg(text, true);
    pushHistory('user', text);
    aiInput.value = '';

    const holder = addMsg('<span class="ai-token">...</span>', false, true);

    const hist = loadHistory().slice(-MAX_TURNS);
    const payload = {
      message: text,
      history: hist,
      temperature: Number(aiTemp.value || 0.7),
      max_tokens: Number(aiMax.value || 800)
    };

    const resp = await fetch('/api/agent', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    if(!resp.ok || !resp.body){
      holder.innerHTML = 'Error contacting AI backend.';
      return;
    }

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    holder.innerHTML = '';
    let buf = '', acc = '';

    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      buf += decoder.decode(value, {stream: true});
      const parts = buf.split('\n\n');
      for(let i=0;i<parts.length-1;i++){
        const line = parts[i].trim();
        if(line.startsWith('data: ')){
          const data = line.slice(6);
          if(data === '[DONE]'){ break; }
          try {
            const json = JSON.parse(data);
            const token = json.delta || json.content || '';
            acc += token;
            holder.innerHTML = formatMessage(acc);
            aiBody.scrollTop = aiBody.scrollHeight;
          } catch(e) {}
        }
      }
      buf = parts[parts.length-1];
    }

    // persist assistant reply
    pushHistory('assistant', acc);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function formatMessage(text){
    const escaped = escapeHtml(String(text || '')).replace(/\r\n/g, '\n');
    const withBold = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    const withCode = withBold.replace(/`([^`]+)`/g, '<code>$1</code>');
    return withCode.replace(/\n/g, '<br>');
  }

  aiSend.addEventListener('click', send);
  aiInput.addEventListener('keypress', (e)=>{
    if(e.key === 'Enter'){ send(); }
  });
  aiClear.addEventListener('click', ()=>{ localStorage.removeItem(STORE_KEY); renderHistory(); });
})();
</script>
</body>
</html>
